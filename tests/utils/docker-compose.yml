services:
  tests:
    build:
      context: ../../
      dockerfile: ./tests/utils/Dockerfile
    volumes:
      - "../../:/app/modules/oxid-connect-essential"
      - "/etc/passwd:/etc/passwd:ro"
      - "/etc/group:/etc/group:ro"
    depends_on:
      - db
    user: ${USER_ID:?You must set the user ID in the .env file}:${GROUP_ID:?You must set the group ID in the .env file}
    environment:
      APP_DATA: "/app_data"
      PHPINI_MEMORY_LIMIT: 1G
      PHPINI_SESSION__GC_MAXLIFETIME: "3600"
      PHP_ZEND_EXTENSIONS: "xdebug.so"
      PHPINI_XDEBUG__START_WITH_REQUEST: trigger
      PHPINI_XDEBUG__OUTPUT_DIR: "/app_data"
      PHPINI_XDEBUG__CLIENT_HOST: ${XDEBUG_REMOTE_HOST:-localhost}
      PHPINI_XDEBUG__CLIENT_PORT: 9000
      PHPINI_XDEBUG__CLI_COLOR: "1"
      PHPINI_XDEBUG__MAX_NESTING_LEVEL: 512
      PHPINI_XDEBUG__VAR_DISPLAY_MAX_CHILDREN: 256
      PHPINI_XDEBUG__VAR_DISPLAY_MAX_DATA: 1024
      PHPINI_XDEBUG__VAR_DISPLAY_MAX_DEPTH: 10
      PHP_IDE_CONFIG: serverName=oxid64-tests.${DOMAIN:-makaira.vm}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: "no"

  db:
    image: mysql:5.7
    volumes:
      - "../test.sql:/docker-entrypoint-initdb.d/test.sql:ro"
    command:
      - "mysqld"
      - "--sql_mode="
      - "--innodb_buffer_pool_size=1G"
      - "--innodb_log_file_size=256M"
      - "--innodb_flush_log_at_trx_commit=1"
      - "--innodb_flush_method=O_DIRECT"
      - "--default-authentication-plugin=mysql_native_password"
      - "--key-buffer-size=256M"
      - "--skip-log-bin"
      - "--server-id=1"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: oxid
      MYSQL_USER: oxid
      MYSQL_PASSWORD: oxid
    restart: "no"
